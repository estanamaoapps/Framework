<!-- require_once https://github.com/estanamaoapps/Framework/raw/master/Utilidades/Data.html -->

<div id="feed" class="total-fluid" style="overflow-x:hidden; overflow-y:auto;">
	<div id="feed_container"></div>
</div>	
<div id="item_content" class="total-fluid" style="overflow-x:hidden; overflow-y:auto;">
	<div id="item_content_container"></div>
</div>
<div id="image_viewer" class="total-fluid" style="overflow-x:auto; overflow-y:auto;">
	<div id="image_viewer_container"></div>
</div>

<script type="text/javascript">
	var php_get_feed_url = "http://plataforma.aplicativoscolmeia.com.br/estanamao_framework/feed_utils/get.php";	
	
	/*****************************************************************************************
	
	! CONFIGS
	
	*****************************************************************************************/
	var CONFIGS_DEFAULT = {
		// url para pegar o feed
		"feed_url": "",
		
		// url para o php que pega o feed (geralmente está na plataforma por questões de erros de segurança)
		"php_get_feed_url": "http://plataforma.aplicativoscolmeia.com.br/estanamao_framework/feed_utils/get.php",
		
		// quando verdadeiro, apenas o primeiro artigo é mostrado diretamente com seu conteúdo (como uma página)
		"show_first_item_only": false,
		
		// se é para mostrar a primeira imagem do primeiro artigo como capa da lista de artigos ("item")
		"show_list_cover": true,
		
		// nome do layout usado para o item da lista do feed
		"list_item_layout" : "list_item",
		
		// nome do layout usado para imagem de capa (topo) da lista do feed
		"list_cover_layout" : "list_cover",
		
		// se é para mostrar a imagem de miniatura do artigo
		"show_list_item_thumbnail": true,
		
		// se é para mostrar o título na pagina do artigo
		"show_page_item_title": true,
		
		// se é para mostrar a data nos itens da lista de artigos
		"show_list_item_date": true,
		
		// formato da data nos itens da lista de artigos (ver mais em hithub: Utilidades/Data.html)
		"list_item_data_format": "|D|/|M|/|Y|"
	};
	
	var CONFIGS = JSON.parse(GET["configs"]);
	
	// construtor das configurações
	function StartConfigs(){
		// atribui os valores padrão, quando não há configuração vinda por GET["configs"]
		for(var i in CONFIGS_DEFAULT)
			if(CONFIGS[i] == null) CONFIGS[i] = CONFIGS_DEFAULT[i];		
	}
	
	/*****************************************************************************************
	
	! FEED
	
	*****************************************************************************************/
	var FEED = null;
	
	function AttachListItem(_index, _item_data){
		
		var item = $('<div class="list-item total-fluid" item-id="' + _index + '"></div>');
		var html = "";
		// item de capa da lista de itens (artigos)
		if(_index == 0 && Layout.layouts["feed_list_cover"] != null){
			html += Layout.layouts["feed_list_cover"](_item_data);
		// itens normal
		}else if(Layout.layouts["feed_list_item"] != null){
			html += Layout.layouts["feed_list_item"](_item_data);
		}
		item.append(html);
		$("#feed").append(item);
		/*
		// inserindo dados nos itens
		var c_array = $(item).find( ".feed-data" ).toArray();
		for(var i in c_array){
			var p = $(c_array[i]).attr("target-data-path");
			var type = $(c_array[i]).attr("target-data-type");
			if(p != null && p != ""){
				var t_array = p.split("/");
				var last_array_elem = _item_data;
				for(var u=0; u<t_array.length; u++){
					last_array_elem = last_array_elem[t_array[u]];
					// insere os dados
					if(u == t_array.length - 1){
						switch(type){
							case "text":
								$(c_array[i]).html(last_array_elem);
							break;							
							case "first_image_as_bg":
								// primeira tag <img> num texto
								$(c_array[i]).css("background-image", GetFirstImgUrlFromContent(last_array_elem));
							break;
							case "date":
							var date = new Date(last_array_elem);
								$(c_array[i]).html(DateUtils.ApplyDateFormat($(c_array[i]).attr("date-type"), [date.getFullYear(), date.getMonth(), date.getDate()]));
							break;
						}						
					}
				}
			}
		}		*/		
		
	
		/*var html = '<div class="total-fluid">';
		var d = new Date(json_feed["feed"]["entry"][i].published["$t"]);
		
		// imagem principal da lista de itens do feed + dados
		if(show_list_cover == true && i == 0){
			html += '<div class="list-item total-fluid list-cover-background list-cover-height" item-id="' + i + '" style="background-image:url(' + GetFirstImgUrlFromContent(json_feed["feed"]["entry"][i]["content"]["$t"]) + ');">';
				
				html += '<table class="total-fluid list-cover-height">';
					html += '<tr class="total-fluid">';
						html += '<td class="total-fluid" style="vertical-align:bottom;">';
							html += '<table class="list-item-height total-fluid list-cover-title-bg">';
								html += '<tr class="total-fluid">';
									html += '<td class="title-color container-fluid list-item-title" style="vertical-align:center;">';
										if(show_list_item_date)												
											html += '<div class="list-item-title-date">' + DateUtils.ApplyDateFormat("|D|/|M|/|Y|", [d.getFullYear(), d.getMonth(), d.getDate()]) + '</div>';											
										if(json_feed["feed"]["entry"][i].title["$t"].length > 70)
											html += '<div>' + json_feed["feed"]["entry"][i].title["$t"].substr(0, 70) + '...</div>';
										else
											html += '<div>' + json_feed["feed"]["entry"][i].title["$t"] + '</div>';
									html += '</td>';
									html += '<td class="arrow-color" style="width:26px;" style="vertical-align:center;"><span class="glyphicon glyphicon-chevron-right list-item-arrow" aria-hidden="true"></span></td>';
								html += '</tr>';
							html += '</table>';
						html += '</td>';
					html += '</tr>';
				html += '</table>';
			html += '</div>';
				
		// item do feed (padrão) 
		}else{
			html += '<div class="list-item" item-id="' + i + '">';
				html += '<table class="list-item-height total-fluid">';
					html += '<tr class="total-fluid">';
					if(show_list_item_thumbnail == true && json_feed["feed"]["entry"][i]["media$thumbnail"] != null && json_feed["feed"]["entry"][i]["media$thumbnail"]["url"] != null && json_feed["feed"]["entry"][i]["media$thumbnail"]["url"] != "")
						html += '<td class="list-item-thumbnail-size"><img class="list-item-thumbnail-size" src="' + json_feed["feed"]["entry"][i]["media$thumbnail"].url + '" /></td>';
					
					html += '<td class="title-color container-fluid list-item-title" style="vertical-align:center;">';
						if(show_list_item_date)												
							html += '<div class="list-item-title-date">' + DateUtils.ApplyDateFormat("|D|/|M|/|Y|", [d.getFullYear(), d.getMonth(), d.getDate()]) + '</div>';											
						if(json_feed["feed"]["entry"][i].title["$t"].length > 70)
							html += '<div>' + json_feed["feed"]["entry"][i].title["$t"].substr(0, 70) + '...</div>';
						else
							html += '<div>' + json_feed["feed"]["entry"][i].title["$t"] + '</div>';
					html += '</td>';
					html += '<td class="arrow-color" style="width:26px;" style="vertical-align:center;"><span class="glyphicon glyphicon-chevron-right list-item-arrow" aria-hidden="true"></span></td>';
					html += '</tr>';
				html += '</table>';
			html += '</div>';
			
			// separator
			html += '<div class="list-item-separator separator-color"></div>';
		}
		html += '</div>';
		
		$("#feed").append(html);*/
	}
	function GetAndAttachFeed(){
		$.ajax({
			method: "GET",
			dataType: "json",
			url: CONFIGS["php_get_feed_url"],
			data: {
				url: CONFIGS["feed_url"]
			}
		}).done(function(json_feed){
			FEED = json_feed;
			if(json_feed["feed"] != null){						
				$("#feed").empty();
				
				// mostra diretamete o conteúdo do primeiro artigo
				if(CONFIGS["show_first_item_only"] == true){
					document.location.hash = "item_0";
				
				// lista de artigos (itens)
				}else{
					for(var i=0; i<json_feed["feed"]["entry"].length; i++){
						AttachListItem(i, json_feed["feed"]["entry"][i]);
					}
					
					$(".list-item").click(function(){						
						document.location.hash = "item_" + $(this).attr("item-id");	
					});
				}
			}
		});	
	}
	
	var feed_selected_item_images = null;
	function AttachItemPage(_item_index){
		var item_data = FEED["feed"]["entry"][parseInt(_item_index)];
					
		$("#item_content_container").empty();
		if(item_data["content"] != null && item_data["content"]["$t"] != null){							
			if(CONFIGS["show_page_item_title"] == true)
				$("#item_content_container").html('<div class="feed-item-page-title feed-item-page-title-color">' + item_data["title"]["$t"] + '</div>');
			$("#item_content_container").append('<div class="feed-item-page font-color">' + item_data["content"]["$t"] + '</div>');
		}
		
		/* pega a url da imagem e desabilita o link dela  */
		var array_images = $("#item_content_container img").toArray();
		feed_selected_item_images = [];
		for(var i in array_images){
			if($(array_images[i]).parent() != null && $(array_images[i]).parent().attr("href") != null && $(array_images[i]).parent().attr("href") != ""){
				feed_selected_item_images[parseInt(i)] = $(array_images[i]).parent().attr("href");
				$(array_images[i]).parent().attr("href", "");
			}else{
				feed_selected_item_images[parseInt(i)] = $(array_images[i]).attr("src");
			}
			$(array_images[i]).parent().attr("onclick", "return false;");
			
			$(array_images[i]).click({"index":i}, function(e){										
				document.location.hash = "image_" + e.data.index;
			});									
		}		
	}
	
	function AttachImageViewer(_image_index){
		array_images = $("#item_content_container img").toArray();		
		$("#image_viewer").html('<img src="' + feed_selected_item_images[parseInt(_image_index)] + '"/>');
	}
	
	window.onhashchange = function(){
		
		// LISTA DE ITENS DO FEED
		if(document.location.hash == "#" || document.location.hash == ""){						
			$("#image_viewer").css("display", "none");
			$("#item_content").css("display", "none");
			$("#feed").css("display", "block");
					
		}else{
			var hash_array = document.location.hash.split("_");					
			
			// PÁGINA DO ITEM
			if(hash_array[0] == "#item"){
				AttachItemPage(hash_array[1]);
				
				$("#item_content").css("display", "block");
				$("#feed").css("display", "none");
				$("#image_viewer").css("display", "none");
						
			// IMAGEM CLICADA NA PÁGINA DO ITEM
			}else if(hash_array[0] == "#image"){
				AttachImageViewer(hash_array[1]);
				
				$("#image_viewer").css("display", "block");
				$("#item_content").css("display", "none");
				$("#feed").css("display", "none");
			}
		}
	}
	
	/*****************************************************************************************
	
	! GENERAL
	
	*****************************************************************************************/
	$( window ).resize(function() {
		AdjustContainers();
	});
	
	function AdjustContainers(){
		$("#image_viewer").height($( window ).height());
		$("#item_content").height($( window ).height());
		$("#feed").height($( window ).height());
	}
	
	// On Load Document
	$(function(){
	
		// CONFIGS
		StartConfigs();
		
		// contents
		$("#image_viewer").css("display", "none");
		$("#item_content").css("display", "none");
		$("#feed").css("display", "block");
		
		// construtor do feed
		GetAndAttachFeed();
		
		// ajusta o tamanho das divs que contem os conteúdos do feed
		AdjustContainers();
	});
</script>
